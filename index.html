<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lyarinet Network Scan Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=JetBrains+Mono&family=Exo+2:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Dark & Vibrant Color Palette */
      --bg-dark: #0D1117;
      --bg-surface: #161B22;
      --border-color: rgba(255, 255, 255, 0.1);
      --text-primary: #c9d1d9;
      --text-secondary: #8b949e;
      --accent-primary: #58A6FF; /* Bright Blue */
      --accent-secondary: #F77BAA; /* Pink/Magenta */
      --accent-glow: rgba(88, 166, 255, 0.3);

      --success: #3FB950;
      --warning: #D29922;
      --error: #F85149;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--bg-dark);
      background-image: radial-gradient(circle at 1px 1px, rgba(255, 255, 255, 0.04) 1px, transparent 0);
      background-size: 25px 25px;
      margin: 0;
      padding: 2rem;
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: auto;
      animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes rowFadeIn {
      from { opacity: 0; transform: translateX(-15px); }
      to { opacity: 1; transform: translateX(0); }
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2.5rem;
      flex-wrap: wrap;
      gap: 1.5rem;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 2rem;
        flex-wrap: wrap;
    }

    h1 {
      font-family: 'Exo 2', sans-serif;
      font-size: 2.5rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 1rem;
      background: linear-gradient(45deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
    }
    h1 i {
        -webkit-text-fill-color: var(--accent-primary);
        text-fill-color: var(--accent-primary);
    }
    
    .search-container {
      background: rgba(22, 27, 34, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      display: flex;
      align-items: center;
      padding: 0.5rem 1rem;
      transition: all 0.3s ease;
    }
    .search-container:focus-within {
      border-color: var(--accent-primary);
      box-shadow: 0 0 15px var(--accent-glow);
    }
    .search-container i {
      color: var(--text-secondary);
      margin-right: 0.75rem;
    }
    #searchInput {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 1rem;
      width: 250px;
      font-family: 'Roboto', sans-serif;
    }
    #searchInput::placeholder {
      color: var(--text-secondary);
    }

    .stats {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .stat-card {
      background: rgba(22, 27, 34, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 0.8rem 1.2rem;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 0.8rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 15px var(--accent-glow);
      border-color: var(--accent-primary);
    }
    .stat-card i { font-size: 1.3rem; }
    .devices-count { color: var(--accent-primary); }
    .unique-mac { color: var(--success); }
    .unknown { color: var(--warning); }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(22, 27, 34, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      margin-bottom: 2rem;
    }

    th, td {
      padding: 16px 20px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    thead {
      background-color: rgba(13, 17, 23, 0.6);
      position: sticky; top: 0; z-index: 10;
    }
    thead th {
      font-family: 'Exo 2', sans-serif;
      font-weight: 600; text-transform: uppercase;
      font-size: 0.8rem; letter-spacing: 1px;
      color: var(--text-secondary);
      border-bottom: 2px solid var(--accent-primary);
    }

    tbody tr {
      transition: background-color 0.3s ease;
      position: relative;
    }
    tbody tr.data-row {
      opacity: 0;
      animation: rowFadeIn 0.5s ease-out forwards;
    }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr::before {
      content: ''; position: absolute; left: 0; top: 0;
      height: 100%; width: 3px;
      background-color: var(--accent-primary);
      transform: scaleY(0); transition: transform 0.3s ease-in-out;
    }
    tbody tr:hover { background-color: rgba(88, 166, 255, 0.08); }
    tbody tr:hover::before { transform: scaleY(1); }
    .mac-address { font-family: 'JetBrains Mono', monospace; font-size: 0.9em; color: var(--text-secondary); }
    .device-type {
      display: inline-flex; align-items: center; gap: 0.4rem;
      padding: 0.3rem 0.6rem; border-radius: 5px; font-size: 0.75rem;
      font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .status-indicator {
      display: inline-block; width: 10px; height: 10px;
      border-radius: 50%; margin-right: 8px; box-shadow: 0 0 8px;
    }
    .status-online { background-color: var(--success); color: var(--success); }
    .status-offline { background-color: var(--error); color: var(--error); }
    .status-unknown { background-color: var(--warning); color: var(--warning); }
    
    footer {
      text-align: center; margin-top: 2rem; font-size: 0.9rem;
      color: var(--text-secondary); padding: 1.5rem;
      border-top: 1px solid var(--border-color);
    }
    .last-updated {
      display: flex; justify-content: center; align-items: center;
      gap: 1rem; margin-top: 1rem;
    }
    .refresh-btn {
      background: var(--accent-primary); color: var(--bg-dark); border: none;
      padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer;
      display: flex; align-items: center; gap: 0.5rem;
      transition: all 0.3s ease; font-weight: 700; font-family: 'Exo 2', sans-serif;
    }
    .refresh-btn:hover { transform: translateY(-2px); box-shadow: 0 0 20px var(--accent-glow); }
    .refresh-btn:active { transform: translateY(0); }
    .refresh-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .refresh-btn .fa-spin { animation: fa-spin 1s linear infinite; }

    .empty-state, .error-state, .no-results-state {
      text-align: center; padding: 4rem; color: var(--text-secondary);
    }
    .empty-state i, .error-state i, .no-results-state i {
      font-size: 3.5rem; margin-bottom: 1rem; display: block;
    }
    .empty-state i { color: var(--accent-primary); }
    .error-state i { color: var(--error); }
    .no-results-state i { color: var(--warning); }
    .hidden { display: none; }
    
    @media (max-width: 992px) {
      .header-left {
        flex-direction: column;
        align-items: flex-start;
        gap: 1.5rem;
      }
    }
    @media (max-width: 768px) {
      body { padding: 1rem; }
      header { flex-direction: column; align-items: flex-start; }
      table { display: block; overflow-x: auto; }
      th, td { min-width: 150px; } /* Ensure cells have minimum width on smaller screens */
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
        <div class="header-left">
            <h1><i class="fas fa-network-wired"></i>Lyarinet Network Scan</h1>
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search devices...">
            </div>
        </div>
        <div class="stats" id="statsContainer">
            <!-- Stats will be populated by JavaScript -->
        </div>
    </header>
    
    <table id="scanTable">
      <thead>
        <tr>
          <th>Status</th>
          <th>IP Address</th>
          <th>MAC Address</th>
          <th>Hostname</th>
          <th>WG/Domain</th>
          <th>Manufacturer</th>
          <th>Type</th>
          <th>Shares</th> <!-- New Column Header -->
        </tr>
      </thead>
      <tbody>
        <!-- Data rows will be inserted here -->
        <tr id="noResultsRow" class="hidden">
          <td colspan="8" class="no-results-state"> <!-- Updated colspan to 8 -->
            <i class="fas fa-search"></i>
            <h3>No Matching Devices</h3>
            <p>Your search returned no results.</p>
          </td>
        </tr>
      </tbody>
    </table>
    
    <footer>
      <p>Â© 2025 All rights reserved.</p>
      <p>Developed by <a href="https://lyarinet.com" target="_blank" style="color: #007bff; text-decoration: none;">Asifagaria</a></p>  
      <div class="last-updated">
        <button class="refresh-btn" id="refreshBtn">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <span id="lastUpdated">Last updated: Just now</span>
      </div>
    </footer>
  </div>

  <script>
    // --- Utility Functions ---

    /**
     * Generates a vibrant HSL color string based on an input string.
     * @param {string} str - The string to generate a color from.
     * @returns {string} A vibrant HSL color string.
     */
    function generateVibrantColorFromString(str) {
      if (!str) return '#444444'; // Default color if no string is provided
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
        hash = hash & hash; // Convert to 32bit integer
      }
      // Ensure hue is positive, saturation and lightness are high for vibrancy
      const h = ((hash % 360) + 360) % 360; // Ensure hue is positive
      const s = 90; // High saturation
      const l = 60; // Medium lightness for vibrancy
      return `hsl(${h}, ${s}%, ${l}%)`;
    }

    /**
     * Determines the best contrast text color (black or white) for a given background color.
     * Uses a luminance calculation for better accuracy.
     * @param {string} bgColor - The background color in hex format (e.g., '#RRGGBB').
     * @returns {string} The contrasting text color ('#000000' or '#FFFFFF').
     */
    function getContrastTextColor(bgColor) {
        // This function assumes bgColor is a hex color string like '#RRGGBB'.
        // If it can be other formats, more parsing would be needed.
        if (!bgColor || bgColor === '#444444') return '#FFFFFF'; // Handle default or invalid colors
        
        try {
            // Convert hex to RGB
            const hex = bgColor.replace('#', '');
            const r = parseInt(hex.substring(0, 2), 16);
            const g = parseInt(hex.substring(2, 4), 16);
            const b = parseInt(hex.substring(4, 6), 16);
            
            // Calculate luminance using the WCAG 2.0 formula
            const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
            
            // Threshold for deciding contrast color (adjust if needed)
            return luminance > 140 ? '#000000' : '#FFFFFF'; 
        } catch (e) {
            console.error("Error calculating contrast color for:", bgColor, e);
            return '#FFFFFF'; // Fallback color in case of parsing error
        }
    }
    
    /**
     * Classifies a device type based on its manufacturer and hostname.
     * @param {object} entry - The device data object.
     * @returns {string} The classified device type.
     */
    function detectDeviceType(entry) {
      if (!entry.manufacturer && !entry.hostname) return 'unknown';
      const manufacturer = (entry.manufacturer || '').toLowerCase();
      const hostname = (entry.hostname || '').toLowerCase();

      if (hostname.includes('router') || manufacturer.includes('cisco') || manufacturer.includes('ubiquiti') || manufacturer.includes('aruba') || manufacturer.includes('mikrotik')) return 'router';
      if (hostname.includes('server') || hostname.includes('srv') || hostname.includes('nas') || hostname.includes('storage') || manufacturer.includes('synology') || manufacturer.includes('qnap')) return 'server';
      if (hostname.includes('phone') || hostname.includes('iphone') || hostname.includes('android') || manufacturer.includes('apple') || manufacturer.includes('samsung') || manufacturer.includes('google')) return 'mobile';
      if (hostname.includes('pc') || hostname.includes('desktop') || hostname.includes('laptop') || manufacturer.includes('dell') || manufacturer.includes('hp') || manufacturer.includes('lenovo')) return 'desktop';
      if (hostname.includes('echo') || hostname.includes('nest') || hostname.includes('iot') || hostname.includes('smart') || manufacturer.includes('sonos') || manufacturer.includes('philips') || manufacturer.includes('amazon') || manufacturer.includes('ring') || manufacturer.includes('xiaomi')) return 'iot';
      
      return 'generic';
    }
    
    /**
     * Formats a MAC address string into the standard XX:XX:XX:XX:XX:XX format.
     * @param {string} mac - The MAC address string to format.
     * @returns {string} The formatted MAC address or 'N/A'.
     */
    function formatMAC(mac) {
      if (!mac) return 'N/A';
      const cleaned = mac.replace(/[^a-fA-F0-9]/g, '').toUpperCase(); // Remove non-hex characters and convert to uppercase
      if (cleaned.length !== 12) return mac; // Return original if it's not a standard 12-hex-char MAC
      return cleaned.match(/.{1,2}/g).join(':'); // Split into pairs and join with ':'
    }
    
    /**
     * Fetches network scan data, populates the table, and updates statistics.
     */
    function loadData() {
      const tbody = document.querySelector('#scanTable tbody');
      const statsContainer = document.querySelector('#statsContainer');
      const lastUpdatedSpan = document.getElementById('lastUpdated');
      const noResultsRow = document.getElementById('noResultsRow'); // Get reference to noResultsRow

      // --- Clear existing data rows and show loading state ---
      const existingDataRows = tbody.querySelectorAll('tr.data-row');
      existingDataRows.forEach(row => row.remove());
      
      // Ensure noResultsRow is hidden during loading/data fetching
      if (noResultsRow) {
          noResultsRow.classList.add('hidden');
      }

      // Add a loading indicator row. Colspan is 8 because we now have 8 columns.
      const loadingRow = document.createElement('tr');
      loadingRow.innerHTML = `<td colspan="8" class="empty-state"><i class="fas fa-spinner fa-spin"></i><h3>Scanning Network...</h3></td>`;
      tbody.prepend(loadingRow); // Add to the beginning of tbody

      // --- Fetch data from JSON file ---
      fetch('scan_results.json?' + new Date().getTime()) // Append timestamp to prevent caching
        .then(response => {
            if (!response.ok) {
                let errorMsg = `HTTP error! Status: ${response.status}`;
                if (response.status === 404) {
                    errorMsg = "scan_results.json not found. Ensure the file exists in the same directory.";
                } else if (response.status === 500) {
                    errorMsg = "Server error while fetching scan results.";
                }
                throw new Error(errorMsg);
            }
            return response.json();
        })
        .then(data => {
          lastUpdatedSpan.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
          
          // Remove the loading row
          if (loadingRow && loadingRow.parentNode) {
             loadingRow.remove();
          }

          // --- Handle Empty Data ---
          if (!data || data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="empty-state"><i class="fas fa-search-minus"></i><h3>No Devices Found</h3><p>Your network scan returned no active devices.</p></td></tr>`;
            statsContainer.innerHTML = ''; // Clear stats if no data
            return;
          }
          
          // --- Populate Stats ---
          const uniqueMACs = new Set(data.map(entry => entry.mac).filter(Boolean)).size; // Count only valid MACs
          const unknownDevices = data.filter(entry => !entry.manufacturer || entry.manufacturer.toLowerCase().includes('unknown')).length;
          
          // --- Calculate Unique Share Count ---
          let allShares = new Set();
          data.forEach(entry => {
              if (entry.shares) {
                  entry.shares.split(',')
                      .map(share => share.trim())
                      .filter(share => share) // Filter out any empty strings
                      .forEach(share => allShares.add(share));
              }
          });
          const uniqueShareCount = allShares.size;

          statsContainer.innerHTML = `
            <div class="stat-card"><i class="fas fa-laptop-house devices-count"></i><span>${data.length} Devices</span></div>
            <div class="stat-card"><i class="fas fa-fingerprint unique-mac"></i><span>${uniqueMACs} Unique MACs</span></div>
            <div class="stat-card"><i class="fas fa-question-circle unknown"></i><span>${unknownDevices} Unknown</span></div>
            <div class="stat-card"><i class="fas fa-share-alt"></i><span>${uniqueShareCount} Unique Shares</span></div> <!-- New Share Count Stat -->
          `;
          
          // --- Populate Table Rows ---
          data.forEach((entry, index) => {
            const row = document.createElement('tr');
            row.classList.add('data-row'); // Add class for easy selection and animation
            
            const status = entry.ip ? 'online' : 'offline';
            const deviceType = detectDeviceType(entry);
            
            const deviceTypeColor = generateVibrantColorFromString(deviceType);
            const deviceTypeTextContrast = getContrastTextColor(deviceTypeColor);
            
            row.style.animationDelay = `${index * 40}ms`;
            
            row.innerHTML = `
              <td><span class="status-indicator status-${status}"></span>${status.charAt(0).toUpperCase() + status.slice(1)}</td>
              <td>${entry.ip || 'N/A'}</td>
              <td class="mac-address">${formatMAC(entry.mac)}</td>
              <td>${entry.hostname || 'N/A'}</td>
              <td>${entry.wg_domain || 'N/A'}</td>
              <td>${entry.manufacturer || 'N/A'}</td>
              <td>
                <span class="device-type" style="background-color: ${deviceTypeColor}; color: ${deviceTypeTextContrast};">
                  <i class="fas ${getDeviceIcon(deviceType)}"></i>
                  <span>${deviceType}</span>
                </span>
              </td>
              <td>${entry.shares || 'N/A'}</td> <!-- New: Displaying Shares -->
            `;
            
            tbody.insertBefore(row, noResultsRow); // Insert new row before the noResultsRow template
          });

          filterTable(); // Apply search filter to the newly loaded data
        })
        .catch(err => {
          console.error('Failed to load scan_results.json:', err);
          if (loadingRow && loadingRow.parentNode) {
             loadingRow.remove();
          }

          tbody.innerHTML = `<tr><td colspan="8" class="error-state"><i class="fas fa-exclamation-triangle"></i><h3>Error Loading Results</h3><p>${err.message}</p></td></tr>`;
        });
    }

    /**
     * Filters the table rows based on the search input.
     * Makes sure to handle the visibility of the "no results" row.
     */
    function filterTable() {
        const searchInput = document.getElementById('searchInput');
        if (!searchInput) {
            console.warn("searchInput element not found. Cannot filter.");
            return;
        }
        const query = searchInput.value.toLowerCase();

        const rows = document.querySelectorAll('#scanTable tbody tr.data-row');
        const noResultsRow = document.getElementById('noResultsRow');
        let visibleCount = 0;

        if (!noResultsRow) {
            console.error("noResultsRow element not found. Cannot manage search visibility.");
            return;
        }

        rows.forEach(row => {
            const rowText = row.textContent.toLowerCase();
            if (rowText.includes(query)) {
                row.classList.remove('hidden');
                visibleCount++;
            } else {
                row.classList.add('hidden');
            }
        });

        if (rows.length > 0) {
            if (visibleCount === 0) {
                noResultsRow.classList.remove('hidden');
            } else {
                noResultsRow.classList.add('hidden');
            }
        } else {
            noResultsRow.classList.add('hidden');
        }
    }
    
    /**
     * Returns the appropriate Font Awesome icon class for a given device type.
     * @param {string} deviceType - The classified device type.
     * @returns {string} The Font Awesome class name.
     */
    function getDeviceIcon(deviceType) {
      switch(deviceType) {
        case 'router': return 'fa-router';
        case 'server': return 'fa-server';
        case 'desktop': return 'fa-desktop';
        case 'mobile': return 'fa-mobile-alt';
        case 'iot': return 'fa-microchip';
        case 'generic': return 'fa-cube';
        default: return 'fa-question';
      }
    }
    
    // --- Event Listeners ---
    
    document.addEventListener('DOMContentLoaded', loadData);
    
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keyup', filterTable);
    } else {
        console.warn("searchInput element not found. Search functionality will not work.");
    }

    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        const icon = refreshBtn.querySelector('i');
        
        refreshBtn.disabled = true;
        icon.classList.remove('fa-sync-alt');
        icon.classList.add('fa-spinner', 'fa-spin');
        
        loadData();
        
        setTimeout(() => {
          icon.classList.remove('fa-spinner', 'fa-spin');
          icon.classList.add('fa-sync-alt');
          refreshBtn.disabled = false;
        }, 1500);
      });
    } else {
        console.warn("refreshBtn element not found. Refresh functionality will not work.");
    }
    
    setInterval(loadData, 60000);
  </script>
</body>
</html>
